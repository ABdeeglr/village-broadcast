include modules.d/*.conf;
load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

worker_processes auto;
rtmp_auto_push on;

events {
    worker_connections 1024;
}

# ==================== RTMP 推流服务 (1935) ====================
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        ack_window 5000000;

        application live {
            live on;
            record off;

            # 1. HLS 路径：必须与 API 代码里的 /tmp/hls 一致
            hls on;
            hls_path /tmp/hls;
            hls_nested off;         # ⚠️ 必须关闭，配合 API 的逻辑
            hls_fragment 3;
            hls_playlist_length 60;
            hls_cleanup on;

            allow publish all;
            allow play all;

            # 2. 回调：必须指向 API 的 3001 端口
            on_publish http://127.0.0.1:3001/api/stream/on-publish;
            on_done    http://127.0.0.1:3001/api/stream/on-done;
        }
    }
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    gzip on;

    # ==================== 前端网页服务 (8080) ====================
    server {
        listen 8080;
        server_name _;
        root /opt/village-broadcast/frontend; # 前端文件目录
        index index.html;

        # 允许跨域
        add_header 'Access-Control-Allow-Origin' '*' always;

        location / {
            try_files $uri $uri/ /index.html;
            add_header Cache-Control "no-cache";
        }

        # 【保留】静态资源缓存（让网页加载更快）
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }

        # 【保留】健康检查
        location /health {
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
        
        # 【保留】RTMP 状态监控页面 (访问 http://IP:8080/stat 查看)
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        location /stat.xsl {
            root /usr/share/nginx/html; # 确保这个目录下有 stat.xsl 文件，没有也无所谓，就是丑点
        }
    }

    # ==================== 视频流分发服务 (8030) ====================
    server {
        listen 8030;
        server_name _;
        
        # 允许跨域总开关
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;

        location /live/ {
            # 3. 读取路径：必须是 /tmp/hls
            alias /tmp/hls/;
            
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }

            # 这里的 CORS 头是必须的
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header Cache-Control "no-cache";

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
                add_header 'Content-Length' 0;
                return 204;
            }
        }
    }
}
